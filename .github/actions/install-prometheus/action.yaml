name: InstallPrometheus
description: 'Installs prometheus'
inputs:
  git_ref:
    description: "The git commit, tag, or branch to check out. Requires a corresponding Karpenter snapshot release"
runs:
  using: "composite"
  steps:
    - uses: ./.github/actions/e2e/install-helm
      with:
        version: v3.12.3 # Pinned to this version since v3.13.0 has issues with anonymous pulls: https://github.com/helm/helm/issues/12423
    - name: add prometheus repo
      shell: bash
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    - name: create monitoring namespace
      shell: bash
      run: |
        kubectl create ns prometheus || true
        kubectl label ns monitoring scrape=enabled --overwrite=true
    - name: install prometheus
      shell: bash
      run: |
        helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
        -n monitoring \
        -f ./.github/actions/install-prometheus/values.yaml \
        --set "kubelet.serviceMonitor.cAdvisorRelabelings[0].targetLabel=metrics_path" \
        --set "kubelet.serviceMonitor.cAdvisorRelabelings[0].action=replace" \
        --set "kubelet.serviceMonitor.cAdvisorRelabelings[0].sourceLabels[0]=__metrics_path__" \
        --wait